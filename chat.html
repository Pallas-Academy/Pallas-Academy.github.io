<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº¤æµ | Pallas Academy</title>
    <style>
        /* åŸºç¡€æ ·å¼ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Georgia', serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f0e8;
            color: #333;
            line-height: 1.6;
            position: relative;
            min-height: 100vh;
        }
        
        /* å¯¼èˆªæŒ‰é’® - ä¸upload.htmlç»Ÿä¸€ */
        .back-btn {
            display: inline-block;
            color: #8B7355;
            text-decoration: none;
            font-weight: bold;
            margin-bottom: 20px;
            padding: 8px 16px;
            border: 1px solid #8B7355;
            border-radius: 5px;
            transition: all 0.3s ease;
        }
        
        .back-btn:hover {
            background-color: #8B7355;
            color: white;
        }
        
        /* ä¸»ä½“å®¹å™¨ - ä¸upload.htmlç»Ÿä¸€ */
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border-top: 5px solid #8B7355;
        }
        
        h1 {
            color: #2C3E50;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.2em;
        }
        
        .logo {
            display: block;
            margin: 0 auto 25px;
            max-width: 200px;
            height: auto;
        }
        
        /* äº¤æµé¡µé¢ç‰¹æœ‰æ ·å¼ */
        .page-description {
            text-align: center;
            color: #7F8C8D;
            margin-bottom: 30px;
            font-size: 1.1em;
        }
        
        .chat-rules {
            background-color: #F9F5F0;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 30px;
            border-left: 4px solid #8B7355;
        }
        
        .chat-rules h3 {
            color: #2C3E50;
            margin-bottom: 15px;
        }
        
        .chat-rules ul {
            padding-left: 20px;
            margin: 0;
        }
        
        .chat-rules li {
            margin-bottom: 8px;
            color: #555;
        }
        
        /* èŠå¤©å†…å®¹åŒºåŸŸ */
        .chat-container {
            width: 100%;
            height: 400px;
            border: 1px solid #EAEAEA;
            border-radius: 8px;
            padding: 20px;
            overflow-y: auto;
            background-color: #FAF8F5;
            margin-bottom: 20px;
        }
        
        .chat-message {
            margin-bottom: 15px;
            padding: 12px;
            border-radius: 8px;
            max-width: 80%;
            word-wrap: break-word;
        }
        
        .user-message {
            background-color: #e3f2fd;
            margin-left: auto;
            border: 1px solid #BBDEFB;
        }
        
        .other-message {
            background-color: #F9F5F0;
            margin-right: auto;
            border: 1px solid #E0E0E0;
        }
        
        .message-info {
            font-size: 0.8em;
            color: #7F8C8D;
            margin-bottom: 5px;
        }
        
        .message-country {
            font-size: 0.7em;
            color: #95A5A6;
            font-style: italic;
        }
        
        /* è¾“å…¥åŒºåŸŸ */
        .input-container {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        #user-name {
            width: 150px;
            padding: 12px 15px;
            border: 2px solid #EAEAEA;
            border-radius: 8px;
            font-family: 'Georgia', serif;
            background-color: #FAF8F5;
            transition: border-color 0.3s ease;
        }
        
        #user-name:focus {
            outline: none;
            border-color: #8B7355;
            background-color: white;
        }
        
        #message-input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #EAEAEA;
            border-radius: 8px;
            font-family: 'Georgia', serif;
            font-size: 1em;
            resize: none;
            height: 80px;
            background-color: #FAF8F5;
            transition: border-color 0.3s ease;
        }
        
        #message-input:focus {
            outline: none;
            border-color: #8B7355;
            background-color: white;
        }
        
        #send-btn {
            padding: 12px 24px;
            background-color: #2C3E50;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        
        #send-btn:hover {
            background-color: #34495E;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        #send-btn:disabled {
            background-color: #95A5A6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        /* çŠ¶æ€æŒ‡ç¤ºå™¨ */
        .status-indicator {
            text-align: center;
            padding: 10px;
            font-size: 0.9em;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: bold;
        }
        
        .status-online {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-offline {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status-connecting {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        /* æç¤ºä¿¡æ¯ */
        .tip {
            text-align: center;
            color: #7F8C8D;
            font-size: 0.9em;
            margin-top: 15px;
        }
        
        .error-tip {
            color: #e74c3c;
            text-align: center;
            margin-top: 10px;
            font-size: 0.9em;
            display: none;
        }
        
        .loading {
            text-align: center;
            color: #3498db;
            font-style: italic;
            padding: 20px;
        }
        
        /* åº•éƒ¨ä¿¡æ¯ */
        footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #EAEAEA;
            color: #7F8C8D;
        }
        
        /* å“åº”å¼é€‚é… */
        @media (max-width: 768px) {
            .container {
                padding: 25px 20px;
            }
            
            .chat-container {
                height: 300px;
            }
            
            .input-container {
                flex-direction: column;
            }
            
            #user-name, #send-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- è¿”å›æŒ‰é’® - ä¸upload.htmlç»Ÿä¸€ -->
        <a href="index.html" class="back-btn">â† è¿”å›é¦–é¡µ</a>
        
        <!-- Logo -->
        <img src="Logo.jpeg" alt="Pallas Academy Logo" class="logo" onerror="this.style.display='none'">
        
        <!-- æ ‡é¢˜ -->
        <h1>Pallas Academy äº¤æµåŒº</h1>
        <p class="page-description">æ€æƒ³ç¢°æ’ï¼ŒçœŸè¯šå¯¹è¯ - ä¸å…¨çƒæ€æƒ³è€…å®æ—¶äº¤æµ</p>

        <!-- è¿æ¥çŠ¶æ€ -->
        <div class="status-indicator status-connecting" id="statusIndicator">
            ğŸ”„ æ­£åœ¨è¿æ¥å…¨çƒèŠå¤©ç½‘ç»œ...
        </div>

        <!-- èŠå¤©è§„åˆ™ -->
        <div class="chat-rules">
            <h3>äº¤æµè§„åˆ™</h3>
            <ul>
                <li>å°Šé‡ä»–äººï¼Œç†æ€§äº¤æµï¼Œç¦æ­¢äººèº«æ”»å‡»</li>
                <li>ç¦æ­¢å‘å¸ƒä½ä¿—ã€è„è¯ã€è‰²æƒ…ã€æš´åŠ›ç­‰è¿è§„å†…å®¹</li>
                <li>èšç„¦æ–‡å­¦ã€å“²å­¦ã€è‰ºæœ¯ã€å†å²ç­‰ä¸»é¢˜ï¼Œæ‹’ç»æ— å…³å¹¿å‘Š</li>
                <li>é¼“åŠ±ä¸åŒè§‚ç‚¹ç¢°æ’ï¼Œä½†éœ€ä¿æŒç¤¼è²Œä¸åŒ…å®¹</li>
                <li>æ¶ˆæ¯å°†æ°¸ä¹…ä¿å­˜å¹¶åœ¨å…¨çƒèŒƒå›´å†…å®æ—¶åŒæ­¥</li>
            </ul>
        </div>

        <!-- èŠå¤©å†…å®¹åŒºåŸŸ -->
        <div class="chat-container" id="chatContainer">
            <div class="loading">æ­£åœ¨åŠ è½½å…¨çƒå¯¹è¯...</div>
        </div>

        <!-- è¾“å…¥åŒºåŸŸ -->
        <div class="input-container">
            <input type="text" id="user-name" placeholder="ä½ çš„åå­—" maxlength="20" value="åŒ¿åç”¨æˆ·">
            <textarea id="message-input" placeholder="è¾“å…¥ä½ çš„è§‚ç‚¹æˆ–ç–‘é—®ï¼ˆæ”¯æŒå¤šè¯­è¨€äº¤æµï¼‰..."></textarea>
            <button id="send-btn" disabled>å‘é€æ¶ˆæ¯</button>
        </div>

        <div class="error-tip" id="errorTip">æ¶ˆæ¯åŒ…å«è¿è§„å†…å®¹ï¼Œè¯·ä¿®æ”¹åé‡æ–°å‘é€ï½</div>
        <div class="tip">ğŸ’¡ å®æ—¶å…¨çƒèŠå¤©ï¼šä½ çš„æ¶ˆæ¯å°†åŒæ­¥åˆ°æ‰€æœ‰ç”¨æˆ·ï¼Œæ”¯æŒä¸­è‹±æ–‡äº¤æµ</div>
        
        <footer>
            <p>Pallas Academy Â· æ™ºæ…§ä¸åˆ›æ„çš„äº¤æ±‡å¤„</p>
        </footer>
    </div>

    <!-- å¼•å…¥ Supabase JS å®¢æˆ·ç«¯ -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Supabase é…ç½®
        const SUPABASE_URL = 'https://weixhdaqjfagzjoyabgn.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndlaXhoZGFxamZhZ3pqb3lhYmduIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzMjA0MDYsImV4cCI6MjA3Nzg5NjQwNn0.lHJJN_o2agcb-R7tA1Qm8zOliMdNBQ-8ydb_YbVr670';

        // åˆå§‹åŒ– Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // DOM å…ƒç´ 
        const chatContainer = document.getElementById('chatContainer');
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        const errorTip = document.getElementById('errorTip');
        const statusIndicator = document.getElementById('statusIndicator');
        const userNameInput = document.getElementById('user-name');

        // å†…å®¹å®‰å…¨è¿‡æ»¤ç³»ç»Ÿ
        const contentFilters = {
            badWords: [
                'æ”»å‡»æ€§è¯æ±‡', 'ä¸å½“ç”¨è¯­', 'åƒåœ¾ä¿¡æ¯', 'å¹¿å‘Šæ¨å¹¿',
                'èµŒåš', 'è¯ˆéª—', 'æ¯’å“', 'æš´åŠ›'
            ],
            
            patterns: [
                /http\:\/\//gi,
                /www\./gi,
                /@\w+/gi,
                /\d{10,}/gi
            ],
            
            checkContent: function(message) {
                if (!message || message.trim().length === 0) return false;
                
                const lowerMessage = message.toLowerCase();
                
                // æ£€æŸ¥åŸºç¡€è¿ç¦è¯
                const hasBadWord = this.badWords.some(word => 
                    word && lowerMessage.includes(word.toLowerCase())
                );
                if (hasBadWord) return false;
                
                // æ£€æŸ¥æ¨¡å¼åŒ¹é…
                const hasBadPattern = this.patterns.some(pattern => 
                    pattern.test(message)
                );
                if (hasBadPattern) return false;
                
                // æ£€æŸ¥æ¶ˆæ¯é•¿åº¦
                if (message.length > 500) return false;
                
                // æ£€æŸ¥é‡å¤å­—ç¬¦
                const repeatedChars = message.match(/(.)\1{10,}/gi);
                if (repeatedChars) return false;
                
                return true;
            }
        };

        // è·å–ç”¨æˆ·å›½å®¶ï¼ˆç®€åŒ–ç‰ˆï¼‰
        async function getUserCountry() {
            try {
                // ä½¿ç”¨æ›´å¯é çš„IP API
                const response = await fetch('https://api.country.is/');
                if (response.ok) {
                    const data = await response.json();
                    return data.country || 'æœªçŸ¥å›½å®¶';
                }
            } catch (error) {
                console.log('è·å–å›½å®¶ä¿¡æ¯å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼');
            }
            return 'æœªçŸ¥å›½å®¶';
        }

        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(timestamp) {
            try {
                const date = new Date(timestamp);
                const hours = date.getHours().toString().padStart(2, '0');
                const minutes = date.getMinutes().toString().padStart(2, '0');
                return `${hours}:${minutes}`;
            } catch (e) {
                return 'åˆšåˆš';
            }
        }

        // HTMLè½¬ä¹‰é˜²æ­¢XSS
        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // åŠ è½½å†å²æ¶ˆæ¯
        async function loadMessages() {
            try {
                updateConnectionStatus('connecting');
                
                const { data: messages, error } = await supabase
                    .from('chat_messages')
                    .select('*')
                    .order('created_at', { ascending: true })
                    .limit(50);

                if (error) {
                    console.error('Supabaseé”™è¯¯:', error);
                    throw error;
                }

                chatContainer.innerHTML = '';
                
                if (!messages || messages.length === 0) {
                    chatContainer.innerHTML = `
                        <div class="chat-message other-message">
                            <div class="message-info">ç³»ç»Ÿ Â· åˆšåˆš</div>
                            <div>æ¬¢è¿æ¥åˆ°Pallaså…¨çƒäº¤æµåŒºï¼å¼€å§‹ç¬¬ä¸€ä¸ªå¯¹è¯å§ï½</div>
                        </div>
                    `;
                } else {
                    messages.forEach(msg => {
                        addMessageToChat(msg, false);
                    });
                }
                
                chatContainer.scrollTop = chatContainer.scrollHeight;
                updateConnectionStatus('online');
                
            } catch (error) {
                console.error('åŠ è½½æ¶ˆæ¯å¤±è´¥:', error);
                chatContainer.innerHTML = `
                    <div class="chat-message other-message">
                        <div class="message-info">ç³»ç»Ÿ Â· åˆšåˆš</div>
                        <div>ç½‘ç»œè¿æ¥ä¸ç¨³å®šï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ååˆ·æ–°é¡µé¢ï½</div>
                    </div>
                `;
                updateConnectionStatus('offline');
            }
        }

        // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©ç•Œé¢
        function addMessageToChat(message, isNew = true) {
            if (!message) return;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message other-message';
            
            messageDiv.innerHTML = `
                <div class="message-info">
                    ${escapeHtml(message.user_name || 'åŒ¿åç”¨æˆ·')} Â· ${formatTime(message.created_at)}
                    <span class="message-country">${message.country || 'æœªçŸ¥åœ°åŒº'}</span>
                </div>
                <div>${escapeHtml(message.message_content)}</div>
            `;
            
            chatContainer.appendChild(messageDiv);
            
            if (isNew) {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        }

        // å‘é€æ¶ˆæ¯
        async function sendMessage() {
            const message = messageInput.value.trim();
            const userName = userNameInput.value.trim() || 'åŒ¿åç”¨æˆ·';
            
            if (!message) {
                showError('è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹ï½');
                return;
            }

            // ä½¿ç”¨å®‰å…¨çš„å†…å®¹æ£€æŸ¥
            if (!contentFilters.checkContent(message)) {
                showError('æ¶ˆæ¯åŒ…å«ä¸åˆé€‚å†…å®¹ï¼Œè¯·ä¿®æ”¹åé‡æ–°å‘é€ï½');
                return;
            }

            // ç¦ç”¨å‘é€æŒ‰é’®é˜²æ­¢é‡å¤å‘é€
            sendBtn.disabled = true;
            sendBtn.textContent = 'å‘é€ä¸­...';

            try {
                const country = await getUserCountry();
                
                const { data, error } = await supabase
                    .from('chat_messages')
                    .insert([
                        {
                            user_name: userName,
                            message_content: message,
                            country: country,
                            is_approved: true
                        }
                    ])
                    .select();

                if (error) {
                    console.error('æ’å…¥é”™è¯¯:', error);
                    throw error;
                }

                // æ¸…ç©ºè¾“å…¥æ¡†
                messageInput.value = '';
                
                // æ˜¾ç¤ºå‘é€æˆåŠŸçš„ç”¨æˆ·æ¶ˆæ¯
                const userMessageDiv = document.createElement('div');
                userMessageDiv.className = 'chat-message user-message';
                userMessageDiv.innerHTML = `
                    <div class="message-info">æˆ‘ Â· åˆšåˆš</div>
                    <div>${escapeHtml(message)}</div>
                `;
                chatContainer.appendChild(userMessageDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;

                // éšè—é”™è¯¯æç¤ºï¼ˆå¦‚æœæœ‰ï¼‰
                errorTip.style.display = 'none';

            } catch (error) {
                console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
                showError('å‘é€å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•ï½');
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = 'å‘é€æ¶ˆæ¯';
                updateSendButtonState();
            }
        }

        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            errorTip.textContent = message;
            errorTip.style.display = 'block';
            setTimeout(() => {
                errorTip.style.display = 'none';
            }, 5000);
        }

        // æ›´æ–°è¿æ¥çŠ¶æ€
        function updateConnectionStatus(status) {
            const statusMap = {
                connecting: ['ğŸ”„ æ­£åœ¨è¿æ¥å…¨çƒèŠå¤©ç½‘ç»œ...', 'status-connecting'],
                online: ['âœ… å·²è¿æ¥å…¨çƒèŠå¤©ç½‘ç»œ', 'status-online'],
                offline: ['âŒ ç½‘ç»œè¿æ¥å·²æ–­å¼€', 'status-offline']
            };
            
            const [text, className] = statusMap[status];
            statusIndicator.textContent = text;
            statusIndicator.className = `status-indicator ${className}`;
            
            updateSendButtonState();
        }

        // æ›´æ–°å‘é€æŒ‰é’®çŠ¶æ€
        function updateSendButtonState() {
            const hasContent = messageInput.value.trim().length > 0;
            const isOnline = statusIndicator.textContent.includes('âœ…');
            sendBtn.disabled = !hasContent || !isOnline;
        }

        // å®æ—¶æ¶ˆæ¯è®¢é˜…
        function subscribeToMessages() {
            try {
                const subscription = supabase
                    .channel('chat-messages')
                    .on(
                        'postgres_changes',
                        {
                            event: 'INSERT',
                            schema: 'public',
                            table: 'chat_messages'
                        },
                        (payload) => {
                            const currentUserName = userNameInput.value.trim() || 'åŒ¿åç”¨æˆ·';
                            if (payload.new.user_name !== currentUserName) {
                                addMessageToChat(payload.new, true);
                            }
                        }
                    )
                    .subscribe((status) => {
                        if (status === 'SUBSCRIBED') {
                            console.log('å®æ—¶è®¢é˜…å·²è¿æ¥');
                        } else {
                            console.log('å®æ—¶è®¢é˜…çŠ¶æ€:', status);
                        }
                    });

                return subscription;
            } catch (error) {
                console.error('å®æ—¶è®¢é˜…å¤±è´¥:', error);
                return null;
            }
        }

        // åˆå§‹åŒ–èŠå¤©åŠŸèƒ½
        async function initChat() {
            console.log('åˆå§‹åŒ–èŠå¤©åŠŸèƒ½...');
            
            // åŠ è½½å†å²æ¶ˆæ¯
            await loadMessages();
            
            // å¯ç”¨å®æ—¶æ¶ˆæ¯
            subscribeToMessages();
            
            // ç»‘å®šå‘é€äº‹ä»¶
            sendBtn.addEventListener('click', sendMessage);
            messageInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // è¾“å…¥æ¡†å˜åŒ–æ—¶æ›´æ–°æŒ‰é’®çŠ¶æ€
            messageInput.addEventListener('input', updateSendButtonState);
            userNameInput.addEventListener('input', updateSendButtonState);
            
            // åˆå§‹çŠ¶æ€æ›´æ–°
            updateSendButtonState();
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMåŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');
            setTimeout(initChat, 100);
        });

        // ç½‘ç»œçŠ¶æ€æ£€æµ‹
        window.addEventListener('online', function() {
            console.log('ç½‘ç»œå·²è¿æ¥');
            loadMessages();
        });

        window.addEventListener('offline', function() {
            console.log('ç½‘ç»œå·²æ–­å¼€');
            updateConnectionStatus('offline');
        });
    </script>
</body>
</html>